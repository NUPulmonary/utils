import pandas as pd


WRAPPER_DIR = "/projects/b1038/Pulmonary/nmarkov/utils/snakemake/wrappers"

WORK_DIR = config['work_dir']
DATA_DIR = f"{WORK_DIR}/data"
SAMPLE_CSV_PATH = config['sample_csv_path'] 
TRANSCRIPTOME = config['transcriptome']
CELLRANGER_PATH = config['cellranger_path']
SAMPLES = pd.read_csv(SAMPLE_CSV_PATH)


rule all:
    input:
        f"{DATA_DIR}/cellranger/metrics_summary.csv",

rule sample_sheet:
    input: SAMPLE_CSV_PATH
    output: f"{DATA_DIR}/{{run_id,\w+}}.csv"
    params:
        slurm__skip=True
    wrapper:
        f"file://{WRAPPER_DIR}/sample_sheet"

rule demultiplex:
    input:
        f"{WORK_DIR}/raw/{{run_id}}",
        f"{WORK_DIR}/raw/{{DATA_DIR}}/{{run_id,\w+}}.csv"
    output: directory("{DATA_DIR}/fastq-run/{run_id}")
    params:
        slurm__account="b1042",
        slurm__partition="genomics",
        slurm__cores=4,
        slurm__hours=2,
        slurm__mem=40,
        cellranger_dir=CELLRANGER_PATH,
        keep_cellranger_output=True,
    wrapper:
        f"file://{WRAPPER_DIR}/mkfastq"

rule cellranger:
    input: 
        lambda x: [f"{DATA_DIR}/fastq-run/{r}" for r in SAMPLES.RunID[SAMPLES.Sample == x.sample].values]
    output: directory(f"{DATA_DIR}/cellranger/{{sample,\w+}}")
    params:
        slurm__account="b1042",
        slurm__partition="genomics",
        slurm__cores=8,
        slurm__hours=16,
        slurm__mem=60,
        chemistry="auto",
        transcriptome=TRANSCRIPTOME,
        cellranger_dir=CELLRANGER_PATH,
        sample_csv_path = SAMPLE_CSV_PATH
    wrapper:
        f"file://{WRAPPER_DIR}/cellranger"

rule metrics_summary:
    input: expand("{{DATA_DIR}}/cellranger/{sample}", sample=SAMPLES.Sample.unique())
    output: "{DATA_DIR}/cellranger/metrics_summary.csv"
    params:
        slurm__skip=True
    wrapper:
        f"file://{WRAPPER_DIR}/metrics_summary"